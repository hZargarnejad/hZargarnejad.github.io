# 2D Flow Simulation Around Multiple Circular Obstacles using WaterLily.jl
ENV["QT_QPA_PLATFORM"] = "xcb"
using WaterLily
using StaticArrays
using Plots
using CUDA

function make_sim(; L=2^5, U=1, Re=250, mem=CuArray)
    ν = U * L / Re
    size = (8L, 4L)
    centers = (SA[2L, 2L], SA[4L, 2L], SA[4L, 1L], SA[3L, 3L], SA[3L, 3L], SA[2L, 3L], SA[2L, 1L], SA[2L, 3L]) #SA[4L, 2L]
    radius = (L / 3, L/2, L/2.5, L/4, L/4, L/3, L/3,L/3)

    # GPU-safe SDF: avoid `norm`
    #sdf = (x, t) -> √sum(abs2, x .- center) - radius
    sdf = (x, t) -> begin
        d_min = √sum(abs2, x .- centers[1]) - radius[1]
        for i in 2:length(centers)
            d = √sum(abs2, x .- centers[i]) - radius[i]
            d_min = min(d_min, d)
        end
        return d_min
    end
    # No map needed
    body = AutoBody(sdf)

    return Simulation(size, (U, 0), L;
                      U=U, ν=ν, body=body,
                      T=Float64, mem=mem)
end

sim = make_sim()

# Run simulation and save GIF
sim_gif!(sim;
    duration=10,
    clims=(-10, 10),
    plotbody=true,
    name="~/practice/circle_flow.gif"
)
