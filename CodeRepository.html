<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Julia Simulation Code</title>

  <!-- Load highlight.js theme -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>

  <!-- Disable text selection and copying -->
  <style>
    pre.nocopy {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      pointer-events: none;
      opacity: 0.95;
    }
    code {
      font-family: Consolas, 'Courier New', monospace;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>

<h2>Julia Simulation Code (GPU Flow with Circular Bodies)</h2>

<pre class="nocopy"><code class="language-julia">
ENV["QT_QPA_PLATFORM"] = "xcb"
using WaterLily
using StaticArrays
using Plots
using CUDA

norm(x) = √sum(abs2, x)

# Define SDF struct for triangle, circles, and one blob
struct TriangleCircleBlobSDF{T}
    centers::NTuple{4, SVector{2, T}}
    radius::NTuple{4, T}
    blob_center::SVector{2, T}
    blob_radius::T
    amplitudes::SVector{6, T}
end

function (sdf::TriangleCircleBlobSDF)(x, t)
    L = 32  # Keep consistent with make_sim
    r_tri, k = L / 3, sqrt(3.0)
    
    # Triangle centered at (3L, L)
    p = x .- SA[3L, L]
    x1 = abs(p[1]) - r_tri
    y1 = p[2] + r_tri / k
    p2 = SA[clamp(x1, -2r_tri, 2r_tri), y1]
    
    if x1 + k * y1 > 0.0
        p2 = SA[clamp(x1 - 0.5 * k * y1, -2r_tri, 2r_tri), -k * x1 - y1] ./ 2.0
    end
    
    d_min = -norm(p2) * sign(p2[2])

    # Blob with sinusoidal boundary
    dx = x .- sdf.blob_center
    r = norm(dx)
    θ = atan(dx[2], dx[1])
    
    r_effective = sdf.blob_radius
    for (k, a_k) in enumerate(sdf.amplitudes)
        r_effective += a_k * sin(k * θ)
    end

    d_blob = r - r_effective
    d_min = min(d_min, d_blob)

    # Static circles
    for i in 1:4
        d = norm(x .- sdf.centers[i]) - sdf.radius[i]
        d_min = min(d_min, d)
    end
    
    return d_min
end

# Simulation constructor
function make_sim(; L=2^5, U=1, Re=250, mem=CuArray)
    ν = U * L / Re
    size = (12L, 4L)

    centers = (
        SA[6.0L, 1.0L],
        SA[2.0L, 2.0L],
        SA[3.0L, 3.0L],
        SA[2.0L, 3.0L]
    )
    radius = (L/2.5, L/4, L/4, L/3)

    blob_center = SA[8.0L, 2.0L]
    blob_radius = L/4 + (L/2) * rand()^0.5
    modes_numb =6
    amplitudes = @SVector [0.2 * blob_radius * (2rand() - 1) for _ in 1:modes_numb]

    sdf = TriangleCircleBlobSDF(centers, radius, blob_center, blob_radius, amplitudes)
    body = AutoBody(sdf)

    return Simulation(size, (U, 0), L;
                      U=U, ν=ν, body=body,
                      T=Float64, mem=mem)
end

sim = make_sim()

sim_gif!(sim;
    duration=10,
    clims=(-10, 10),
    plotbody=true,
    dpi=300
)

</code></pre>

</body>
</html>
